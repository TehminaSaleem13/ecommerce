<% if user_signed_in? %>
  <div class="dashboard-container <%= current_user.role == 'seller' ? (@your_products.empty? ? 'default-margin' : 'seller-margin') : (@products.empty? ? 'default-margin' : 'buyer-margin') %>">
    <h1>Welcome to Your Dashboard</h1>

    <div class="user-profile-card">
      <div class="profile-left">
        <div class="avatar-container">
          <% if current_user.avatar.attached? %>
            <%= image_tag current_user.avatar, class: "user-avatar", style: "width: 100px; height: 100px; object-fit: cover; border-radius: 50%;" %>
          <% else %>
            <div class="default-avatar" style="width: 100px; height: 100px; background-color: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 40px; color: #fff;"><%= current_user.full_name[0].upcase %></span>
            </div>
          <% end %>
          <div class="avatar-hover-overlay">
            <%= form_with(model: current_user, url: user_registration_path, method: :put, multipart: true, id: "avatar-form", data: { remote: true }) do |f| %>
              <%= f.file_field :avatar, class: "avatar-input", accept: "image/*", style: "opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;", onchange: "this.form.submit();" %>
              <%= f.submit "Update", style: "display: none;" %>
            <% end %>
          </div>
        </div>

        <div class="user-details">
          <h3><%= current_user.full_name %></h3>
          <p><%= current_user.role.capitalize %></p>
        </div>
      </div>

      <div class="profile-right">
        <%= button_to "Logout", destroy_user_session_path, method: :delete, class: "logout-btn", form: { onsubmit: "return confirm('Are you sure you want to logout?');" } %>
        <%= link_to cart_path, class: 'cart-icon-link' do %>
          <i class="fas fa-shopping-cart"></i>
        <% end %>
      </div>
    </div>

    <!-- Search Field -->
   <div class="search-container">
  <% if @q.present? %>
    <%= search_form_for @q, url: dashboard_index_path, method: :get, html: { class: 'form-inline' } do |f| %>
      <div class="input-group">
        <%= f.search_field :title_cont, class: 'form-control', placeholder: 'Search for products...' %>
        <div class="input-group-append">
          <%= f.submit 'Search', class: 'btn btn-primary' %>
        </div>
      </div>
    <% end %>
  <% else %>
    <form action="<%= dashboard_index_path %>" method="get" class="form-inline">
      <div class="input-group">
        <input type="text" name="q[title_cont]" class="form-control" placeholder="Search for products...">
        <div class="input-group-append">
          <input type="submit" value="Search" class="btn btn-primary">
        </div>
      </div>
    </form>
  <% end %>
</div>

    <% if current_user.role == 'seller' %>
      <div class="create-product-section mb-8">
        <%= link_to 'Create Product', new_product_path, class: 'create-product-btn' %>
      </div>

      <ul class="nav nav-tabs" id="productTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="your-products-tab" data-toggle="tab" href="#your-products" role="tab" aria-controls="your-products" aria-selected="true">Your Products</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="all-products-tab" data-toggle="tab" href="#all-products" role="tab" aria-controls="all-products" aria-selected="false">All Products</a>
        </li>
      </ul>
      <div class="tab-content" id="productTabsContent">
        <div class="tab-pane fade show active" id="your-products" role="tabpanel" aria-labelledby="your-products-tab">
          <div class="products-container">
            <div class="products-header">
              <h2>Your Products</h2>
            </div>
            <%= render partial: 'products/product_list', locals: {
              products: @your_products,
              show_actions: true,
              show_images: true,
              empty_message: "You currently have no products. Click \"Create Product\" to add your first product."
            } %>
            <div class="pagination-container">
              <%= paginate @your_products, param_name: 'your_products_page' %>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="all-products" role="tabpanel" aria-labelledby="all-products-tab">
          <div class="products-container">
            <div class="products-header">
              <h2>All Products</h2>
            </div>
            <%= render partial: 'products/product_list', locals: {
              products: @all_products,
              show_actions: false,
              show_images: true,
              empty_message: "No other products are available right now."
            } %>
            <div class="pagination-container">
              <%= paginate @all_products, param_name: 'all_products_page' %>
            </div>
          </div>
        </div>
      </div>
    <% elsif current_user.role == 'buyer' %>
      <div class="products-container">
        <div class="products-header">
          <h2>All Products</h2>
        </div>
        <%= render partial: 'products/product_list', locals: {
          products: @products,
          show_actions: false,
          show_images: true,
          empty_message: "No products are available right now."
        } %>
        <div class="pagination-container">
          <%= paginate @products %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="dashboard-container default-margin">
    <h1>Welcome to Your Dashboard</h1>
    <div class="user-profile-card">
      <div class="profile-right">
        <%= link_to "Login", new_user_session_path, class: "login-btn" %>
        <%= link_to cart_path, class: 'cart-icon-link' do %>
          <i class="fas fa-shopping-cart"></i>
        <% end %>
      </div>
    </div>

    <!-- Search Field -->
    <div class="search-container">
      <%= search_form_for @q, url: dashboard_index_path, method: :get, html: { class: 'form-inline' } do |f| %>
        <div class="input-group">
          <%= f.search_field :title_cont, class: 'form-control', placeholder: 'Search for products...' %>
          <div class="input-group-append">
            <%= f.submit 'Search', class: 'btn btn-primary' %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="products-container">
      <div class="products-header">
        <h2>All Products</h2>
      </div>
      <%= render partial: 'products/product_list', locals: {
        products: @products,
        show_actions: false,
        show_images: true,
        empty_message: "No products are available right now."
      } %>
      <div class="pagination-container">
        <%= paginate @products %>
      </div>
    </div>
  </div>
<% end %>
